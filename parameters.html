<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical Parameters Randomizer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #e8e8e8;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 300;
            font-size: 2.5rem;
            letter-spacing: 0.1em;
            color: #f0f0f0;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .dynamic-card, .style-card, .foa-card {
            cursor: pointer;
        }

        .card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: #888;
            margin-bottom: 0.75rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 600;
            min-height: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
            transition: opacity 0.2s ease;
        }

        .card-value.changing {
            opacity: 0.3;
        }

        .dynamic-card .card-value {
            color: #ff6b6b;
            font-size: 3rem;
            font-weight: 700;
            font-style: italic;
        }

        .style-card .card-value {
            color: #4ecdc4;
            font-size: 1.6rem;
        }

        .foa-card .card-value {
            color: #ffe66d;
            font-size: 1.4rem;
        }

        .buttons-container {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 1rem 2rem;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.98);
        }

        .randomize-all {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 1.2rem 3rem;
            font-size: 1.1rem;
        }

        .randomize-all:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .individual-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .individual-buttons button {
            padding: 0.6rem 1.2rem;
            font-size: 0.85rem;
        }

        .btn-dynamic { border-color: #ff6b6b; color: #ff6b6b; }
        .btn-dynamic:hover { background: rgba(255, 107, 107, 0.2); }
        
        .btn-style { border-color: #4ecdc4; color: #4ecdc4; }
        .btn-style:hover { background: rgba(78, 205, 196, 0.2); }
        
        .btn-foa { border-color: #ffe66d; color: #ffe66d; }
        .btn-foa:hover { background: rgba(255, 230, 109, 0.2); }

        .btn-edit {
            margin-top: 1.5rem;
            border-color: #aaa;
            color: #aaa;
            padding: 0.6rem 1.2rem;
            font-size: 0.85rem;
        }
        .btn-edit:hover { background: rgba(170, 170, 170, 0.2); }

        .keyboard-hint {
            text-align: center;
            margin-top: 2rem;
            color: #666;
            font-size: 0.85rem;
        }

        /* Count-in styles */
        .countin-card {
            display: flex;
            flex-direction: column;
        }

        .countin-card .countin-beat {
            font-size: 3rem;
            font-weight: 700;
            color: #a29bfe;
            text-align: center;
            min-height: 1.5em;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .countin-card .countin-beat.active {
            color: #fff;
            text-shadow: 0 0 20px #a29bfe;
        }

        .countin-tempo-display {
            font-size: 0.9rem;
            color: #a29bfe;
            text-align: center;
            min-height: 1.5em;
            margin-bottom: 0.5rem;
        }

        .countin-controls {
            margin-bottom: 0.75rem;
        }

        .tempo-mode {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .tempo-mode-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(162, 155, 254, 0.3);
            color: #888;
            padding: 0.3rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tempo-mode-btn:hover {
            background: rgba(162, 155, 254, 0.1);
            transform: none;
        }

        .tempo-mode-btn.active {
            background: rgba(162, 155, 254, 0.2);
            border-color: #a29bfe;
            color: #a29bfe;
        }

        .tempo-input-row, .tempo-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .tempo-input {
            width: 70px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(162, 155, 254, 0.3);
            border-radius: 4px;
            color: #a29bfe;
            font-size: 1.1rem;
            padding: 0.3rem 0.5rem;
            text-align: center;
        }

        .tempo-input:focus {
            outline: none;
            border-color: #a29bfe;
        }

        .tempo-label {
            color: #666;
            font-size: 0.85rem;
        }

        .tempo-display #next-tempo {
            font-size: 1.3rem;
            font-weight: 600;
            color: #a29bfe;
        }

        .btn-reroll {
            background: none;
            border: 1px solid rgba(162, 155, 254, 0.3);
            color: #888;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-reroll:hover {
            background: rgba(162, 155, 254, 0.2);
            color: #a29bfe;
            border-color: #a29bfe;
            transform: none;
        }

        .countin-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-countin {
            border-color: #a29bfe;
            color: #a29bfe;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            min-width: 50px;
        }
        .btn-countin:hover {
            background: rgba(162, 155, 254, 0.2);
        }

        .btn-stop {
            border-color: #ff7675;
            color: #ff7675;
        }
        .btn-stop:hover {
            background: rgba(255, 118, 117, 0.2);
        }

        .review-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .toggle-label {
            font-size: 0.75rem;
            color: #666;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: 0.3s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: #666;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: rgba(162, 155, 254, 0.3);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(16px);
            background-color: #a29bfe;
        }

        /* Review Panel - Modal Popup */
        .review-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 900;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .review-overlay.active {
            display: flex;
        }

        .review-panel {
            background: #1a1a2e;
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            width: 100%;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .review-header h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #888;
            font-weight: 500;
        }

        .review-close {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .review-close:hover {
            color: #fff;
            transform: none;
        }

        .review-params {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .review-params span {
            margin-right: 1.5rem;
        }

        .review-params .param-label {
            color: #666;
        }

        .review-params .dynamic-val { color: #ff6b6b; }
        .review-params .style-val { color: #4ecdc4; }
        .review-params .foa-val { color: #ffe66d; }
        .review-params .tempo-val { color: #a29bfe; }

        .review-sliders {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .review-slider-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .review-slider-group label {
            font-size: 0.85rem;
            color: #888;
            display: flex;
            justify-content: space-between;
        }

        .review-slider-group label span.score {
            color: #fff;
            font-weight: 600;
        }

        .review-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .review-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .review-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .review-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .slider-foa::-webkit-slider-thumb { background: #ffe66d; }
        .slider-foa::-moz-range-thumb { background: #ffe66d; }
        
        .slider-commitment::-webkit-slider-thumb { background: #4ecdc4; }
        .slider-commitment::-moz-range-thumb { background: #4ecdc4; }
        
        .slider-accuracy::-webkit-slider-thumb { background: #ff6b6b; }
        .slider-accuracy::-moz-range-thumb { background: #ff6b6b; }

        .review-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-log {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 0.8rem 2rem;
        }

        .btn-skip {
            border-color: #666;
            color: #666;
        }

        /* Log Section */
        .log-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 2rem;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .log-header h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            font-weight: 500;
        }

        .btn-clear-log {
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #666;
            padding: 0.3rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-clear-log:hover {
            border-color: #ff6b6b;
            color: #ff6b6b;
            transform: none;
        }

        .log-entries {
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid #667eea;
        }

        .log-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #666;
        }

        .log-entry-params {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 0.5rem;
        }

        .log-entry-params span {
            margin-right: 1rem;
        }

        .log-entry-scores {
            display: flex;
            gap: 1.5rem;
            font-size: 0.9rem;
        }

        .log-entry-scores .score-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .log-entry-scores .score-label {
            color: #666;
        }

        .log-entry-scores .score-value {
            color: #a29bfe;
            font-weight: 600;
        }

        .log-empty {
            color: #555;
            font-style: italic;
            text-align: center;
            padding: 2rem;
        }

        kbd {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 0.2rem;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: block;
        }

        .modal {
            background: #1a1a2e;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 16px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            font-weight: 400;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: #fff;
            transform: none;
        }

        .edit-section {
            margin-bottom: 2rem;
        }

        .edit-section h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .edit-section h3 .count {
            font-size: 0.75rem;
            color: #666;
            font-weight: normal;
        }

        .edit-section.dynamic h3 { color: #ff6b6b; }
        .edit-section.style h3 { color: #4ecdc4; }
        .edit-section.foa h3 { color: #ffe66d; }
        .edit-section.review h3 { color: #a29bfe; }

        .edit-section textarea {
            width: 100%;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            color: #e8e8e8;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        .edit-section textarea:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .edit-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .btn-reset {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        .btn-reset:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .card-value {
                font-size: 1.5rem !important;
            }
            
            .dynamic-card .card-value {
                font-size: 2.5rem !important;
            }

            .modal {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Musical Parameters</h1>
        
        <div class="cards-container">
            <div class="card dynamic-card" onclick="randomizeDynamic()">
                <div class="card-label">Dynamic</div>
                <div class="card-value" id="dynamic">â€”</div>
            </div>
            
            <div class="card style-card" onclick="randomizeStyle()">
                <div class="card-label">Style</div>
                <div class="card-value" id="style">â€”</div>
            </div>
            
            <div class="card foa-card" onclick="randomizeFoA()">
                <div class="card-label">Focus of Attention</div>
                <div class="card-value" id="foa">â€”</div>
            </div>

            <div class="card countin-card">
                <div class="card-label">Count-In <span id="audio-status" title="Tap to enable audio">ðŸ”‡</span></div>
                <div class="countin-beat" id="countin-beat">â€”</div>
                <div class="countin-tempo" id="countin-tempo-display"></div>
                
                <div class="countin-controls">
                    <div class="tempo-mode">
                        <button class="tempo-mode-btn active" id="btn-random" onclick="setTempoMode('random')">Random</button>
                        <button class="tempo-mode-btn" id="btn-fixed" onclick="setTempoMode('fixed')">Fixed</button>
                    </div>
                    <div class="tempo-input-row" id="tempo-input-row" style="display:none;">
                        <input type="number" id="fixed-tempo" min="40" max="240" value="120" class="tempo-input">
                        <span class="tempo-label">BPM</span>
                    </div>
                    <div class="tempo-display" id="tempo-random-display">
                        <span id="next-tempo">â€”</span> <span class="tempo-label">BPM</span>
                        <button class="btn-reroll" onclick="rerollTempo()" title="New tempo">â†»</button>
                    </div>
                </div>

                <div class="countin-buttons">
                    <button class="btn-countin" onclick="startCountin(4)">4</button>
                    <button class="btn-countin" onclick="startCountin(8)">8</button>
                    <button class="btn-countin btn-stop" onclick="stopCountin(false)" id="btn-stop" style="display:none;">Stop</button>
                </div>
                <div class="review-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="review-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">Review after</span>
                </div>
            </div>
        </div>
        
        <div class="buttons-container">
            <button class="randomize-all" onclick="randomizeAll()">Randomize All</button>
        </div>
        
        <div class="individual-buttons">
            <button class="btn-dynamic" onclick="randomizeDynamic()">Dynamic</button>
            <button class="btn-style" onclick="randomizeStyle()">Style</button>
            <button class="btn-foa" onclick="randomizeFoA()">Focus</button>
        </div>

        <div class="buttons-container">
            <button class="btn-edit" onclick="openEditor()">Edit Parameters</button>
        </div>

        <!-- Review Panel Popup -->
        <div class="review-overlay" id="review-overlay">
            <div class="review-panel" id="review-panel">
            <div class="review-header">
                <h3>Review Your Take</h3>
                <button class="review-close" onclick="closeReview()">&times;</button>
            </div>
            <div class="review-params" id="review-params"></div>
            <div class="review-sliders" id="review-sliders">
                <!-- Sliders generated dynamically -->
                </div>
            <div class="review-buttons">
                <button class="btn-skip" onclick="closeReview()">Skip</button>
                <button class="btn-log" onclick="logReview()">Log Review</button>
            </div>
            </div>
        </div>

        <!-- Log Section -->
        <div class="log-section" id="log-section">
            <div class="log-header">
                <h3>Practice Log <span id="log-count"></span></h3>
                <button class="btn-clear-log" onclick="clearLog()">Clear All</button>
            </div>
            <div class="log-entries" id="log-entries">
                <div class="log-empty" id="log-empty">No entries yet. Complete a count-in and log your review.</div>
            </div>
        </div>
        
        <div class="keyboard-hint">
            Press <kbd>Space</kbd> to randomize all, or <kbd>D</kbd> <kbd>S</kbd> <kbd>F</kbd> for individual parameters
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h2>
                Edit Parameters
                <button class="modal-close" onclick="closeEditor()">&times;</button>
            </h2>

            <div class="edit-section dynamic">
                <h3>Dynamics <span class="count" id="dynamic-count"></span></h3>
                <textarea id="edit-dynamics"></textarea>
                <div class="edit-hint">One item per line</div>
            </div>

            <div class="edit-section style">
                <h3>Styles <span class="count" id="style-count"></span></h3>
                <textarea id="edit-styles"></textarea>
                <div class="edit-hint">One item per line</div>
            </div>

            <div class="edit-section foa">
                <h3>Focus of Attention <span class="count" id="foa-count"></span></h3>
                <textarea id="edit-foa"></textarea>
                <div class="edit-hint">One item per line</div>
            </div>

            <div class="edit-section review">
                <h3>Review Parameters <span class="count" id="review-params-count"></span></h3>
                <textarea id="edit-review-params"></textarea>
                <div class="edit-hint">One item per line â€” these are the sliders shown after each take</div>
            </div>

            <div class="modal-buttons">
                <button class="btn-reset" onclick="resetToDefaults()">Reset to Defaults</button>
                <button class="btn-save" onclick="saveChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Default values
        const defaultDynamics = [
            'ppp', 'pp', 'p', 'mp', 'mf', 'f', 'ff', 'fff'
        ];

        const defaultStyles = [
            // Articulation & Attack
            'Legato', 'Staccato', 'Marcato', 'Tenuto',
            'Accented', 'Detached', 'Connected', 'Punchy', 'Crisp',
            
            // Emotional/Expressive
            'Lyrical', 'Singing', 'Expressive', 'Passionate', 'Tender',
            'Melancholic', 'Joyful', 'Triumphant', 'Mysterious', 'Playful',
            'Serene', 'Agitated', 'Nostalgic', 'Hopeful', 'Yearning',
            'Defiant', 'Contemplative', 'Exuberant', 'Wistful', 'Urgent',
            
            // Character/Quality
            'Warm', 'Bright', 'Dark', 'Round', 'Focused',
            'Broad', 'Narrow', 'Rich', 'Thin', 'Full',
            'Hollow', 'Brilliant', 'Mellow', 'Edgy', 'Smooth',
            'Rough', 'Silky', 'Velvety', 'Metallic', 'Wooden',
            
            // Movement/Energy
            'Flowing', 'Driving', 'Floating', 'Grounded', 'Suspended',
            'Propulsive', 'Relaxed', 'Tense', 'Released', 'Weighted',
            'Light', 'Heavy', 'Buoyant', 'Dragging', 'Pushing',
            
            // Jazz/Contemporary
            'Swinging', 'Laid-back', 'On top', 'Behind the beat', 'In the pocket',
            'Conversational', 'Bluesy', 'Angular', 'Sparse', 'Dense',
            'Cool', 'Hot', 'Earthy', 'Ethereal', 'Gutsy'
        ];

        const defaultFocusOfAttention = [
            // Sound Production
            'Pitch center', 'Tone quality', 'Beginning of note', 'End of note',
            'Middle of note', 'Note transitions', 'Release of sound',
            'Resonance', 'Overtones', 'Core of sound', 'Projection',
            
            // Physical Awareness
            'Weight of body', 'Softness of eyes', 'Relaxed jaw',
            'Open throat', 'Low shoulders', 'Grounded feet',
            'Balanced posture', 'Free neck', 'Soft hands',
            'Breath support', 'Back expansion',
            
            // Spatial/Environmental
            'Sound of room', 'Space around you', 'Sound traveling outward',
            'Sound returning', 'Filling the space', 'Intimate projection',
            
            // Musical Elements
            'Rhythmic placement', 'Melodic shape', 'Harmonic color',
            'Dynamic contour', 'Phrase direction', 'Musical line',
            'Breath rhythm', 'Pulse feeling', 'Groove center',
            
            // Mindfulness/Internal
            'Place of ease', 'Center of calm', 'Inner stillness',
            'Present moment', 'Letting go', 'Non-judgment',
            'Curious observation', 'Acceptance', 'Effortlessness',
            'Joy in sound', 'Connection to music', 'Listening deeply'
        ];

        // Current active values (load from localStorage or use defaults)
        let dynamics = JSON.parse(localStorage.getItem('dynamics')) || [...defaultDynamics];
        let styles = JSON.parse(localStorage.getItem('styles')) || [...defaultStyles];
        let focusOfAttention = JSON.parse(localStorage.getItem('focusOfAttention')) || [...defaultFocusOfAttention];

        // Review parameters
        const defaultReviewParams = [
            'Focus of attention',
            'Hearing ahead'
        ];
        let reviewParams = JSON.parse(localStorage.getItem('reviewParams')) || [...defaultReviewParams];

        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function animateChange(elementId, newValue) {
            const element = document.getElementById(elementId);
            element.classList.add('changing');
            setTimeout(() => {
                element.textContent = newValue;
                element.classList.remove('changing');
            }, 150);
        }

        function randomizeDynamic() {
            animateChange('dynamic', getRandomItem(dynamics));
        }

        function randomizeStyle() {
            animateChange('style', getRandomItem(styles));
        }

        function randomizeFoA() {
            animateChange('foa', getRandomItem(focusOfAttention));
        }

        function randomizeAll() {
            randomizeDynamic();
            setTimeout(randomizeStyle, 50);
            setTimeout(randomizeFoA, 100);
        }

        // Editor functions
        function openEditor() {
            document.getElementById('edit-dynamics').value = dynamics.join('\n');
            document.getElementById('edit-styles').value = styles.join('\n');
            document.getElementById('edit-foa').value = focusOfAttention.join('\n');
            document.getElementById('edit-review-params').value = reviewParams.join('\n');
            updateCounts();
            document.getElementById('modal').classList.add('active');
        }

        function closeEditor() {
            document.getElementById('modal').classList.remove('active');
        }

        function updateCounts() {
            const dynamicLines = document.getElementById('edit-dynamics').value.split('\n').filter(l => l.trim()).length;
            const styleLines = document.getElementById('edit-styles').value.split('\n').filter(l => l.trim()).length;
            const foaLines = document.getElementById('edit-foa').value.split('\n').filter(l => l.trim()).length;
            const reviewLines = document.getElementById('edit-review-params').value.split('\n').filter(l => l.trim()).length;
            
            document.getElementById('dynamic-count').textContent = `(${dynamicLines} items)`;
            document.getElementById('style-count').textContent = `(${styleLines} items)`;
            document.getElementById('foa-count').textContent = `(${foaLines} items)`;
            document.getElementById('review-params-count').textContent = `(${reviewLines} items)`;
        }

        function saveChanges() {
            dynamics = document.getElementById('edit-dynamics').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);
            
            styles = document.getElementById('edit-styles').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);
            
            focusOfAttention = document.getElementById('edit-foa').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            reviewParams = document.getElementById('edit-review-params').value
                .split('\n')
                .map(s => s.trim())
                .filter(s => s.length > 0);

            // Save to localStorage
            localStorage.setItem('dynamics', JSON.stringify(dynamics));
            localStorage.setItem('styles', JSON.stringify(styles));
            localStorage.setItem('focusOfAttention', JSON.stringify(focusOfAttention));
            localStorage.setItem('reviewParams', JSON.stringify(reviewParams));

            closeEditor();
            randomizeAll();
        }

        function resetToDefaults() {
            if (confirm('Reset all parameters to defaults? Your custom changes will be lost.')) {
                dynamics = [...defaultDynamics];
                styles = [...defaultStyles];
                focusOfAttention = [...defaultFocusOfAttention];
                reviewParams = [...defaultReviewParams];

                localStorage.removeItem('dynamics');
                localStorage.removeItem('styles');
                localStorage.removeItem('focusOfAttention');
                localStorage.removeItem('reviewParams');

                document.getElementById('edit-dynamics').value = dynamics.join('\n');
                document.getElementById('edit-styles').value = styles.join('\n');
                document.getElementById('edit-foa').value = focusOfAttention.join('\n');
                document.getElementById('edit-review-params').value = reviewParams.join('\n');
                updateCounts();
            }
        }

        // Update counts on textarea input
        document.getElementById('edit-dynamics').addEventListener('input', updateCounts);
        document.getElementById('edit-styles').addEventListener('input', updateCounts);
        document.getElementById('edit-foa').addEventListener('input', updateCounts);
        document.getElementById('edit-review-params').addEventListener('input', updateCounts);

        // Close modal on overlay click
        document.getElementById('modal').addEventListener('click', (e) => {
            if (e.target.id === 'modal') {
                closeEditor();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if modal is open or if typing in textarea
            if (document.getElementById('modal').classList.contains('active')) {
                if (e.key === 'Escape') {
                    closeEditor();
                }
                return;
            }

            if (e.code === 'Space') {
                e.preventDefault();
                randomizeAll();
            } else if (e.key.toLowerCase() === 'd') {
                randomizeDynamic();
            } else if (e.key.toLowerCase() === 's') {
                randomizeStyle();
            } else if (e.key.toLowerCase() === 'f') {
                randomizeFoA();
            }
        });

        // Count-in functionality
        let countinInterval = null;
        let audioContext = null;
        let isAudioUnlocked = false;
        let tempoMode = 'random'; // 'random' or 'fixed'
        let nextTempo = null;
        let clickBuffer = null;
        let accentBuffer = null;

        // Create click sound buffers
        function createClickBuffer(frequency, duration) {
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < length; i++) {
                const t = i / sampleRate;
                const envelope = Math.exp(-t * 30); // Quick decay
                data[i] = Math.sin(2 * Math.PI * frequency * t) * envelope * 0.5;
            }
            return buffer;
        }

        // Create and unlock audio context for iOS
        async function unlockAudio() {
            if (isAudioUnlocked && audioContext?.state === 'running') {
                return true;
            }
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Resume if suspended
                await audioContext.resume();
                
                // Create buffers for click sounds
                clickBuffer = createClickBuffer(800, 0.1);
                accentBuffer = createClickBuffer(1200, 0.1);
                
                // Play silent buffer to fully unlock
                const silentBuffer = audioContext.createBuffer(1, 1, 22050);
                const source = audioContext.createBufferSource();
                source.buffer = silentBuffer;
                source.connect(audioContext.destination);
                source.start();
                
                isAudioUnlocked = true;
                
                // Update UI to show audio is ready
                const audioStatus = document.getElementById('audio-status');
                if (audioStatus) {
                    audioStatus.textContent = 'ðŸ”Š';
                    audioStatus.title = 'Audio enabled';
                }
                
                console.log('Audio unlocked successfully, state:', audioContext.state);
                return true;
            } catch (e) {
                console.error('Failed to unlock audio:', e);
                return false;
            }
        }

        // Unlock audio on user interaction
        async function handleUserInteraction() {
            await unlockAudio();
        }
        
        ['touchstart', 'touchend', 'click'].forEach(event => {
            document.addEventListener(event, handleUserInteraction, { passive: true });
        });

        function getRandomTempo() {
            // Random tempo between 60 and 160 BPM
            return Math.floor(Math.random() * 101) + 60;
        }

        function rerollTempo() {
            nextTempo = getRandomTempo();
            document.getElementById('next-tempo').textContent = nextTempo;
        }

        function setTempoMode(mode) {
            tempoMode = mode;
            document.getElementById('btn-random').classList.toggle('active', mode === 'random');
            document.getElementById('btn-fixed').classList.toggle('active', mode === 'fixed');
            document.getElementById('tempo-input-row').style.display = mode === 'fixed' ? 'flex' : 'none';
            document.getElementById('tempo-random-display').style.display = mode === 'random' ? 'flex' : 'none';
            
            if (mode === 'random' && !nextTempo) {
                rerollTempo();
            }
        }

        function getCurrentTempo() {
            if (tempoMode === 'fixed') {
                return parseInt(document.getElementById('fixed-tempo').value) || 120;
            } else {
                return nextTempo || getRandomTempo();
            }
        }

        function playClick(isDownbeat) {
            if (!audioContext || audioContext.state !== 'running' || !clickBuffer) {
                console.log('Audio not ready');
                return;
            }
            
            try {
                const source = audioContext.createBufferSource();
                source.buffer = isDownbeat ? accentBuffer : clickBuffer;
                
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 1.0;
                
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                source.start(0);
            } catch (e) {
                console.error('Playback error:', e);
            }
        }

        async function startCountin(beats) {
            // Ensure audio is unlocked before starting
            const unlocked = await unlockAudio();
            if (!unlocked) {
                alert('Please tap the screen first to enable audio');
                return;
            }
            
            stopCountin(false); // Don't reroll when starting
            
            const tempo = getCurrentTempo();
            const intervalMs = (60 / tempo) * 1000;
            let currentBeat = 1;
            
            document.getElementById('countin-tempo-display').textContent = `â™© = ${tempo}`;
            document.getElementById('btn-stop').style.display = 'inline-block';
            
            function tick() {
                const beatDisplay = document.getElementById('countin-beat');
                beatDisplay.textContent = currentBeat;
                beatDisplay.classList.add('active');
                
                playClick(currentBeat === 1);
                
                setTimeout(() => {
                    beatDisplay.classList.remove('active');
                }, intervalMs * 0.3);
                
                currentBeat++;
                if (currentBeat > beats) {
                    stopCountin(true, true); // Reroll after finishing, and show review
                }
            }
            
            tick();
            countinInterval = setInterval(tick, intervalMs);
        }

        function stopCountin(shouldReroll = true, completed = false) {
            const tempo = getCurrentTempo();
            
            if (countinInterval) {
                clearInterval(countinInterval);
                countinInterval = null;
            }
            document.getElementById('countin-beat').textContent = 'â€”';
            document.getElementById('countin-beat').classList.remove('active');
            document.getElementById('countin-tempo-display').textContent = '';
            document.getElementById('btn-stop').style.display = 'none';
            
            // Show review panel if count-in completed and toggle is on
            if (completed && document.getElementById('review-toggle').checked) {
                showReview(tempo);
            }
            
            // Generate new random tempo for next time only if requested
            if (shouldReroll && tempoMode === 'random') {
                rerollTempo();
            }
        }

        // Initialize tempo
        rerollTempo();

        // Review and Log functionality
        let currentReviewData = null;
        let practiceLog = JSON.parse(localStorage.getItem('practiceLog')) || [];

        function showReview(tempo) {
            const dynamic = document.getElementById('dynamic').textContent;
            const style = document.getElementById('style').textContent;
            const foa = document.getElementById('foa').textContent;
            
            currentReviewData = { dynamic, style, foa, tempo, timestamp: new Date().toISOString() };
            
            document.getElementById('review-params').innerHTML = `
                <span><span class="param-label">Dynamic:</span> <span class="dynamic-val">${dynamic}</span></span>
                <span><span class="param-label">Style:</span> <span class="style-val">${style}</span></span>
                <span><span class="param-label">Focus:</span> <span class="foa-val">${foa}</span></span>
                <span><span class="param-label">Tempo:</span> <span class="tempo-val">${tempo} BPM</span></span>
            `;
            
            // Generate sliders dynamically
            const slidersContainer = document.getElementById('review-sliders');
            slidersContainer.innerHTML = reviewParams.map((param, index) => {
                const paramId = `score-${index}`;
                return `
                    <div class="review-slider-group">
                        <label>${param} <span class="score" id="${paramId}-display">5</span></label>
                        <input type="range" min="1" max="10" value="5" class="review-slider" id="${paramId}" 
                               oninput="document.getElementById('${paramId}-display').textContent = this.value">
                    </div>
                `;
            }).join('');
            
            document.getElementById('review-overlay').classList.add('active');
        }

        function closeReview() {
            document.getElementById('review-overlay').classList.remove('active');
            currentReviewData = null;
        }

        function updateScoreDisplay(type) {
            const value = document.getElementById(`score-${type}`).value;
            document.getElementById(`score-${type}-display`).textContent = value;
        }

        function logReview() {
            if (!currentReviewData) return;
            
            // Collect scores dynamically
            const scores = {};
            reviewParams.forEach((param, index) => {
                const slider = document.getElementById(`score-${index}`);
                scores[param] = slider ? parseInt(slider.value) : 5;
            });
            
            const entry = {
                ...currentReviewData,
                scores
            };
            
            practiceLog.unshift(entry);
            localStorage.setItem('practiceLog', JSON.stringify(practiceLog));
            
            renderLog();
            closeReview();
        }

        function renderLog() {
            const container = document.getElementById('log-entries');
            const emptyMsg = document.getElementById('log-empty');
            const countSpan = document.getElementById('log-count');
            
            if (practiceLog.length === 0) {
                emptyMsg.style.display = 'block';
                countSpan.textContent = '';
                container.innerHTML = '<div class="log-empty" id="log-empty">No entries yet. Complete a count-in and log your review.</div>';
                return;
            }
            
            countSpan.textContent = `(${practiceLog.length})`;
            
            container.innerHTML = practiceLog.map((entry, index) => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString([], { month: 'short', day: 'numeric' });
                
                // Generate score items dynamically
                const scoreItems = Object.entries(entry.scores).map(([label, value]) => 
                    `<div class="score-item"><span class="score-label">${label}:</span> <span class="score-value">${value}</span></div>`
                ).join('');
                
                return `
                    <div class="log-entry">
                        <div class="log-entry-header">
                            <span>${dateStr} at ${timeStr}</span>
                            <span>${entry.tempo} BPM</span>
                        </div>
                        <div class="log-entry-params">
                            <span class="dynamic-val">${entry.dynamic}</span>
                            <span class="style-val">${entry.style}</span>
                            <span class="foa-val">${entry.foa}</span>
                        </div>
                        <div class="log-entry-scores">
                            ${scoreItems}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearLog() {
            if (confirm('Clear all log entries? This cannot be undone.')) {
                practiceLog = [];
                localStorage.removeItem('practiceLog');
                renderLog();
            }
        }

        // Close review on overlay click
        document.getElementById('review-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'review-overlay') {
                closeReview();
            }
        });

        // Initialize log on page load
        renderLog();

        // Initialize with random values
        randomizeAll();
    </script>
</body>
</html>