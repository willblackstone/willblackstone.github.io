<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Judging Mind</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;1,400&family=Lato:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #1a1714;
    --surface: #211e1a;
    --border: #3a3530;
    --text: #e8dfd4;
    --text-muted: #8a7e74;
    --accent: #c9a96e;
    --accent-dim: rgba(201,169,110,0.12);
    --self-color: #e07060;
    --other-color: #6090c0;
    --custom-color: #80b080;
    --danger: #c06060;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Lato', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    line-height: 1.6;
  }

  /* TABS */
  .tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 0 2rem;
  }
  .tab-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: 'Lato', sans-serif;
    font-weight: 400;
    font-size: 0.8rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 1rem 1.5rem 0.9rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    position: relative;
    bottom: -1px;
  }
  .tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }
  .tab-btn:hover:not(.active) { color: var(--text); }

  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* JOURNAL TAB */
  .journal-wrap {
    max-width: 680px;
    margin: 0 auto;
    padding: 3rem 2rem 5rem;
  }

  .page-title {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 400;
    color: var(--text);
    margin-bottom: 0.25rem;
  }
  .page-subtitle {
    color: var(--text-muted);
    font-size: 0.85rem;
    letter-spacing: 0.05em;
    margin-bottom: 2.5rem;
  }

  /* ENTRY FORM */
  .entry-form {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.75rem;
    margin-bottom: 2.5rem;
  }

  .form-row {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  label {
    display: block;
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.4rem;
  }

  select, input[type="text"], textarea, input[type="password"], input[type="url"] {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Lato', sans-serif;
    font-weight: 300;
    font-size: 0.95rem;
    border-radius: 5px;
    padding: 0.6rem 0.85rem;
    width: 100%;
    transition: border-color 0.2s;
    outline: none;
  }
  select:focus, input:focus, textarea:focus {
    border-color: var(--accent);
  }
  select option { background: var(--surface); }

  .field-category { flex: 0 0 180px; }
  .field-text { flex: 1; min-width: 200px; }

  textarea {
    resize: vertical;
    min-height: 80px;
    line-height: 1.5;
  }

  .btn {
    font-family: 'Lato', sans-serif;
    font-weight: 400;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-size: 0.78rem;
    padding: 0.65rem 1.5rem;
    border-radius: 5px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .btn-primary {
    background: var(--accent);
    color: #1a1714;
  }
  .btn-primary:hover { filter: brightness(1.1); }
  .btn-secondary {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--text-muted); color: var(--text); }
  .btn-danger {
    background: transparent;
    color: var(--danger);
    border: 1px solid var(--border);
    font-size: 0.72rem;
    padding: 0.35rem 0.75rem;
  }
  .btn-danger:hover { border-color: var(--danger); }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 1.25rem;
  }

  /* ADD CATEGORY INLINE */
  .add-category-toggle {
    font-size: 0.72rem;
    color: var(--accent);
    background: none;
    border: none;
    cursor: pointer;
    letter-spacing: 0.05em;
    padding: 0;
    margin-top: 0.3rem;
    display: block;
    text-decoration: none;
  }
  .add-category-toggle:hover { opacity: 0.8; }
  .add-cat-row {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    align-items: center;
  }
  .add-cat-row input { flex: 1; font-size: 0.85rem; padding: 0.45rem 0.75rem; }
  .add-cat-row .btn { font-size: 0.7rem; padding: 0.45rem 0.85rem; }

  /* HISTORY */
  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  .history-title {
    font-family: 'Playfair Display', serif;
    font-style: italic;
    color: var(--text-muted);
    font-size: 1rem;
  }
  .entry-count {
    font-size: 0.75rem;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
  }
  .filter-chip {
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.3rem 0.85rem;
    border-radius: 99px;
    border: 1px solid var(--border);
    background: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-chip.active, .filter-chip:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ENTRY CARDS */
  .entries-list { display: flex; flex-direction: column; gap: 0.75rem; }
  .entry-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 1rem 1.25rem;
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    animation: fadeIn 0.3s ease;
    border-left-width: 3px;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .entry-card[data-cat="Self"] { border-left-color: var(--self-color); }
  .entry-card[data-cat="Other"] { border-left-color: var(--other-color); }
  .entry-card[data-cat="custom"] { border-left-color: var(--custom-color); }

  .entry-body { flex: 1; }
  .entry-cat-badge {
    display: inline-block;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.15rem 0.55rem;
    border-radius: 3px;
    background: var(--accent-dim);
    color: var(--accent);
    margin-bottom: 0.4rem;
  }
  .entry-card[data-cat="Self"] .entry-cat-badge { background: rgba(224,112,96,0.15); color: var(--self-color); }
  .entry-card[data-cat="Other"] .entry-cat-badge { background: rgba(96,144,192,0.15); color: var(--other-color); }

  .entry-text {
    font-size: 0.95rem;
    color: var(--text);
    line-height: 1.55;
  }
  .entry-meta {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-top: 0.35rem;
  }
  .delete-btn {
    background: none;
    border: none;
    color: var(--border);
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    padding: 0.2rem;
    transition: color 0.15s;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .delete-btn:hover { color: var(--danger); }

  .empty-state {
    text-align: center;
    padding: 3rem 0;
    color: var(--text-muted);
    font-style: italic;
    font-family: 'Playfair Display', serif;
  }

  /* SETTINGS TAB */
  .settings-wrap {
    max-width: 560px;
    margin: 0 auto;
    padding: 3rem 2rem 5rem;
  }
  .settings-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }
  .settings-subtitle {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-bottom: 2.5rem;
  }
  .settings-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
  }
  .settings-section h3 {
    font-family: 'Playfair Display', serif;
    font-weight: 400;
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }
  .settings-section p {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-bottom: 1.25rem;
    line-height: 1.5;
  }
  .settings-section p a {
    color: var(--accent);
  }
  .field-group { margin-bottom: 1rem; }
  .sync-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.25rem;
    flex-wrap: wrap;
  }
  .status-msg {
    font-size: 0.8rem;
    margin-top: 0.75rem;
    padding: 0.5rem 0.85rem;
    border-radius: 4px;
    display: none;
  }
  .status-msg.ok { display: block; background: rgba(128,176,128,0.15); color: var(--custom-color); }
  .status-msg.err { display: block; background: rgba(192,96,96,0.15); color: var(--danger); }
  .status-msg.info { display: block; background: var(--accent-dim); color: var(--accent); }

  /* DATA section */
  .data-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.5rem; }

  /* Divider */
  .divider { border: none; border-top: 1px solid var(--border); margin: 1.25rem 0; }

  /* Categories manager in settings */
  .cat-list { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; }
  .cat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 0.5rem 0.85rem;
    font-size: 0.88rem;
  }
  .cat-item.builtin .delete-btn { opacity: 0.2; cursor: default; }
</style>
</head>
<body>

<nav class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('journal')">Journal</button>
  <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
</nav>

<!-- JOURNAL TAB -->
<div id="tab-journal" class="tab-panel active">
  <div class="journal-wrap">
    <h1 class="page-title">The Judging Mind</h1>
    <p class="page-subtitle">&nbsp;</p>

    <div class="entry-form">
      <div class="form-row">
        <div class="field-category">
          <label for="cat-select">Judgement of</label>
          <select id="cat-select"></select>
          <button class="add-category-toggle" onclick="toggleAddCat()">+ add category</button>
          <div class="add-cat-row" id="add-cat-row" style="display:none">
            <input type="text" id="new-cat-input" placeholder="e.g. Situation…" maxlength="40">
            <button class="btn btn-secondary" onclick="addCategory()">Add</button>
            <button class="btn btn-secondary" onclick="toggleAddCat()">✕</button>
          </div>
        </div>
        <div class="field-text">
          <label for="judgement-text">The judgement said…</label>
          <textarea id="judgement-text" placeholder="Write down what the judging mind said…"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="logEntry()">Log it</button>
      </div>
    </div>

    <div class="history-header">
      <span class="history-title">what's been noticed</span>
      <span class="entry-count" id="entry-count">0 entries</span>
    </div>

    <div class="filter-bar" id="filter-bar"></div>

    <div class="entries-list" id="entries-list">
      <div class="empty-state">Nothing logged yet.<br>The mind is either quiet, or unobserved.</div>
    </div>
  </div>
</div>

<!-- SETTINGS TAB -->
<div id="tab-settings" class="tab-panel">
  <div class="settings-wrap">
    <h2 class="settings-title">Settings</h2>
    <p class="settings-subtitle">sync, manage categories, export data</p>

    <div class="settings-section">
      <h3>GitHub Gist Sync</h3>
      <p>Your data is stored in your browser's localStorage. To sync across devices, connect a private GitHub Gist. Generate a token at <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a> — needs only the <code>gist</code> scope.</p>

      <div class="field-group">
        <label>GitHub Personal Access Token</label>
        <input type="password" id="gh-token" placeholder="ghp_…" autocomplete="off">
      </div>
      <div class="field-group">
        <label>Gist ID <span style="color:var(--text-muted);font-size:0.75rem;text-transform:none;">(leave empty to create a new one)</span></label>
        <input type="text" id="gh-gist-id" placeholder="e.g. 4a2b8c…">
      </div>

      <div class="sync-actions">
        <button class="btn btn-primary" onclick="syncPush()">Push to Gist</button>
        <button class="btn btn-secondary" onclick="syncPull()">Pull from Gist</button>
        <button class="btn btn-secondary" onclick="saveGhSettings()">Save credentials</button>
      </div>
      <div class="status-msg" id="sync-status"></div>
    </div>

    <div class="settings-section">
      <h3>Categories</h3>
      <p>Manage your judgement categories. Built-in ones cannot be deleted.</p>
      <ul class="cat-list" id="cat-manager-list"></ul>
      <div class="add-cat-row">
        <input type="text" id="settings-new-cat" placeholder="New category name…" maxlength="40">
        <button class="btn btn-secondary" onclick="addCategoryFromSettings()">Add</button>
      </div>
    </div>

    <div class="settings-section">
      <h3>Data</h3>
      <p>Export or clear all your locally stored entries.</p>
      <div class="data-actions">
        <button class="btn btn-secondary" onclick="exportJSON()">Export JSON</button>
        <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
        <button class="btn btn-danger" onclick="clearAll()">Clear all entries</button>
      </div>
    </div>
  </div>
</div>

<script>
// ── State ────────────────────────────────────────────────────────────────────
const BUILTIN = ['Self', 'Other'];
let state = {
  entries: [],
  categories: [...BUILTIN],
  filter: 'All'
};

function loadState() {
  try {
    const raw = localStorage.getItem('judgement-tracker');
    if (raw) {
      const parsed = JSON.parse(raw);
      state.entries = parsed.entries || [];
      state.categories = parsed.categories || [...BUILTIN];
      // ensure builtins
      BUILTIN.forEach(b => { if (!state.categories.includes(b)) state.categories.unshift(b); });
    }
  } catch(e) {}
}

function saveState() {
  localStorage.setItem('judgement-tracker', JSON.stringify({ entries: state.entries, categories: state.categories }));
  // also save gh creds separately
}

// ── UI: Tabs ─────────────────────────────────────────────────────────────────
function switchTab(name) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b => {
    if (b.textContent.toLowerCase() === name) b.classList.add('active');
  });
  if (name === 'settings') renderSettingsCats();
}

// ── UI: Category Select ───────────────────────────────────────────────────────
function populateCatSelect() {
  const sel = document.getElementById('cat-select');
  const current = sel.value;
  sel.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
  if (state.categories.includes(current)) sel.value = current;
}

function toggleAddCat() {
  const row = document.getElementById('add-cat-row');
  row.style.display = row.style.display === 'none' ? 'flex' : 'none';
  if (row.style.display === 'flex') document.getElementById('new-cat-input').focus();
}

function addCategory() {
  const input = document.getElementById('new-cat-input');
  const name = input.value.trim();
  if (!name || state.categories.includes(name)) { input.focus(); return; }
  state.categories.push(name);
  saveState();
  populateCatSelect();
  document.getElementById('cat-select').value = name;
  input.value = '';
  toggleAddCat();
  renderFilterBar();
}

function addCategoryFromSettings() {
  const input = document.getElementById('settings-new-cat');
  const name = input.value.trim();
  if (!name || state.categories.includes(name)) { input.focus(); return; }
  state.categories.push(name);
  saveState();
  populateCatSelect();
  renderSettingsCats();
  renderFilterBar();
  input.value = '';
}

function deleteCategory(cat) {
  if (BUILTIN.includes(cat)) return;
  if (!confirm(`Remove "${cat}"? Existing entries with this category will be kept.`)) return;
  state.categories = state.categories.filter(c => c !== cat);
  saveState();
  populateCatSelect();
  renderSettingsCats();
  renderFilterBar();
}

function renderSettingsCats() {
  const list = document.getElementById('cat-manager-list');
  list.innerHTML = state.categories.map(c => `
    <li class="cat-item ${BUILTIN.includes(c) ? 'builtin' : ''}">
      <span>${c}${BUILTIN.includes(c) ? ' <span style="color:var(--text-muted);font-size:0.7rem;">(built-in)</span>' : ''}</span>
      <button class="delete-btn" onclick="deleteCategory('${c}')" ${BUILTIN.includes(c) ? 'disabled' : ''} title="Remove">✕</button>
    </li>`).join('');
}

// ── UI: Filter ────────────────────────────────────────────────────────────────
function renderFilterBar() {
  const bar = document.getElementById('filter-bar');
  const cats = ['All', ...state.categories];
  bar.innerHTML = cats.map(c =>
    `<button class="filter-chip ${state.filter === c ? 'active' : ''}" onclick="setFilter('${c}')">${c}</button>`
  ).join('');
}

function setFilter(cat) {
  state.filter = cat;
  renderFilterBar();
  renderEntries();
}

// ── Entries ───────────────────────────────────────────────────────────────────
function logEntry() {
  const text = document.getElementById('judgement-text').value.trim();
  const cat = document.getElementById('cat-select').value;
  if (!text) {
    document.getElementById('judgement-text').focus();
    return;
  }
  const entry = {
    id: Date.now().toString(),
    cat,
    text,
    ts: new Date().toISOString()
  };
  state.entries.unshift(entry);
  saveState();
  document.getElementById('judgement-text').value = '';
  renderEntries();
  autoSyncPush();
}

function deleteEntry(id) {
  state.entries = state.entries.filter(e => e.id !== id);
  saveState();
  renderEntries();
}

function renderEntries() {
  const list = document.getElementById('entries-list');
  const filtered = state.filter === 'All' ? state.entries : state.entries.filter(e => e.cat === state.filter);
  
  const count = document.getElementById('entry-count');
  count.textContent = `${state.entries.length} ${state.entries.length === 1 ? 'entry' : 'entries'}`;

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state">${state.filter === 'All' ? 'Nothing logged yet.' : `No entries for <em>${state.filter}</em>.`}</div>`;
    return;
  }

  list.innerHTML = filtered.map(e => {
    const d = new Date(e.ts);
    const dateStr = d.toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
    const timeStr = d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
    const isBuiltin = BUILTIN.includes(e.cat);
    const catType = isBuiltin ? e.cat : 'custom';
    return `
    <div class="entry-card" data-cat="${catType}">
      <div class="entry-body">
        <span class="entry-cat-badge">${e.cat}</span>
        <div class="entry-text">${escapeHtml(e.text)}</div>
        <div class="entry-meta">${dateStr} · ${timeStr}</div>
      </div>
      <button class="delete-btn" onclick="deleteEntry('${e.id}')" title="Delete">✕</button>
    </div>`;
  }).join('');
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ── GitHub Gist Sync ──────────────────────────────────────────────────────────
function saveGhSettings() {
  const token = document.getElementById('gh-token').value.trim();
  const gistId = document.getElementById('gh-gist-id').value.trim();
  localStorage.setItem('gh-token', token);
  localStorage.setItem('gh-gist-id', gistId);
  showStatus('sync-status', 'Credentials saved locally.', 'ok');
}

function getGhCreds() {
  return {
    token: document.getElementById('gh-token').value.trim() || localStorage.getItem('gh-token') || '',
    gistId: document.getElementById('gh-gist-id').value.trim() || localStorage.getItem('gh-gist-id') || ''
  };
}

async function syncPush() {
  const { token, gistId } = getGhCreds();
  if (!token) { showStatus('sync-status', 'Please enter a GitHub token first.', 'err'); return; }
  showStatus('sync-status', 'Pushing…', 'info');
  const content = JSON.stringify({ entries: state.entries, categories: state.categories }, null, 2);
  const body = {
    description: 'Judgement Tracker Data',
    public: false,
    files: { 'judgement-tracker.json': { content } }
  };
  try {
    let url = 'https://api.github.com/gists';
    let method = 'POST';
    if (gistId) { url += '/' + gistId; method = 'PATCH'; }
    const res = await fetch(url, {
      method,
      headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`GitHub responded: ${res.status} ${res.statusText}`);
    const data = await res.json();
    // store gist id if new
    if (!gistId) {
      localStorage.setItem('gh-gist-id', data.id);
      document.getElementById('gh-gist-id').value = data.id;
    }
    showStatus('sync-status', `Pushed successfully. Gist ID: ${data.id}`, 'ok');
  } catch(e) {
    showStatus('sync-status', 'Push failed: ' + e.message, 'err');
  }
}

async function syncPull() {
  const { token, gistId } = getGhCreds();
  if (!token || !gistId) { showStatus('sync-status', 'Token and Gist ID are required to pull.', 'err'); return; }
  showStatus('sync-status', 'Pulling…', 'info');
  try {
    const res = await fetch(`https://api.github.com/gists/${gistId}`, {
      headers: { Authorization: 'token ' + token }
    });
    if (!res.ok) throw new Error(`GitHub responded: ${res.status}`);
    const data = await res.json();
    const file = data.files['judgement-tracker.json'];
    if (!file) throw new Error('No judgement-tracker.json found in this Gist.');
    const parsed = JSON.parse(file.content);
    if (!confirm(`Pull will replace your local data (${state.entries.length} entries) with remote data (${(parsed.entries||[]).length} entries). Continue?`)) return;
    state.entries = parsed.entries || [];
    state.categories = parsed.categories || [...BUILTIN];
    BUILTIN.forEach(b => { if (!state.categories.includes(b)) state.categories.unshift(b); });
    saveState();
    populateCatSelect();
    renderFilterBar();
    renderEntries();
    showStatus('sync-status', `Pulled ${state.entries.length} entries from Gist.`, 'ok');
  } catch(e) {
    showStatus('sync-status', 'Pull failed: ' + e.message, 'err');
  }
}

function showStatus(id, msg, type) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.className = 'status-msg ' + type;
}

// ── Export ─────────────────────────────────────────────────────────────────────
function exportJSON() {
  const blob = new Blob([JSON.stringify({ entries: state.entries, categories: state.categories }, null, 2)], { type: 'application/json' });
  download(blob, 'judgement-tracker.json');
}

function exportCSV() {
  const rows = [['id','category','text','timestamp']];
  state.entries.forEach(e => rows.push([e.id, e.cat, `"${e.text.replace(/"/g,'""')}"`, e.ts]));
  const blob = new Blob([rows.map(r => r.join(',')).join('\n')], { type: 'text/csv' });
  download(blob, 'judgement-tracker.csv');
}

function download(blob, name) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

function clearAll() {
  if (!confirm('Delete all entries? This cannot be undone.')) return;
  state.entries = [];
  saveState();
  renderEntries();
}

// ── Enter key shortcut ────────────────────────────────────────────────────────
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    if (document.getElementById('tab-journal').classList.contains('active')) logEntry();
  }
});

// ── Auto Sync ─────────────────────────────────────────────────────────────────
async function autoSyncPull() {
  const { token, gistId } = getGhCreds();
  if (!token || !gistId) return;
  showStatus('sync-status', 'Syncing…', 'info');
  try {
    const res = await fetch(`https://api.github.com/gists/${gistId}`, {
      headers: { Authorization: 'token ' + token }
    });
    if (!res.ok) throw new Error(`GitHub responded: ${res.status}`);
    const data = await res.json();
    const file = data.files['judgement-tracker.json'];
    if (!file) throw new Error('No judgement-tracker.json found in this Gist.');
    const parsed = JSON.parse(file.content);
    state.entries = parsed.entries || [];
    state.categories = parsed.categories || [...BUILTIN];
    BUILTIN.forEach(b => { if (!state.categories.includes(b)) state.categories.unshift(b); });
    saveState();
    populateCatSelect();
    renderFilterBar();
    renderEntries();
    showStatus('sync-status', `Synced — ${state.entries.length} entries.`, 'ok');
  } catch(e) {
    showStatus('sync-status', 'Pull failed: ' + e.message, 'err');
  }
}

async function autoSyncPush() {
  const { token, gistId } = getGhCreds();
  if (!token || !gistId) return;
  const content = JSON.stringify({ entries: state.entries, categories: state.categories }, null, 2);
  try {
    const res = await fetch(`https://api.github.com/gists/${gistId}`, {
      method: 'PATCH',
      headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ description: 'Judgement Tracker Data', public: false, files: { 'judgement-tracker.json': { content } } })
    });
    if (!res.ok) throw new Error(`GitHub responded: ${res.status}`);
    showStatus('sync-status', 'Saved to Gist.', 'ok');
  } catch(e) {
    showStatus('sync-status', 'Push failed: ' + e.message, 'err');
  }
}

// ── Init ──────────────────────────────────────────────────────────────────────
loadState();
const savedToken = localStorage.getItem('gh-token');
const savedGist = localStorage.getItem('gh-gist-id');
if (savedToken) document.getElementById('gh-token').value = savedToken;
if (savedGist) document.getElementById('gh-gist-id').value = savedGist;

populateCatSelect();
renderFilterBar();
renderEntries();
autoSyncPull();
</script>
</body>
</html>